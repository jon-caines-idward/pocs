
<html>
<head>
  <title>Audience Lift Demo</title>
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WBKWRT72');</script>
<!-- End Google Tag Manager -->
  <script>
    // create LS keys if required
    (function() {
      const key1 = 'cohort_ids';
      if (!localStorage.getItem(key1)) {
        const cohorts = ["33917"];          
        localStorage.setItem(key1, JSON.stringify(cohorts));
        console.log(`Set localStorage key '${key1}' with cohorts array.`);
      } else {
        console.log(`localStorage key '${key1}' already exists.`);
      }
      const key2 = 'cuid';
      if (!localStorage.getItem(key2)) {
        const cuid = 'f660ab912ec121d1b1e928a0bb4bc61b15f5ad44d5efdc4e1c92a25e99b8e44a';
        localStorage.setItem(key2, cuid);
        console.log(`Set localStorage key '${key2}' with CUID.`);
      } else {
        console.log(`localStorage key '${key2}' already exists.`);
      }
    })();
      (function() {
        const key1 = 'cohort_ids'; 
        const key2 = 'cuid';
        const data1 = localStorage.getItem(key1);
        const data2 = localStorage.getItem(key2);
        if (!data1) {
          console.warn(`localStorage key '${key1}' not found.`);
          return;
        }
        if (!data2) {
          console.warn(`localStorage key '${key2}' not found.`);
          return;
        }
      let cohorts;
      let anonId;
      try {
        cohorts = JSON.parse(data1);
      } catch (e) {
        console.error(`Error parsing JSON from localStorage key '${key1}':`, e);
        return;
      }
      try {
        anonId = data2;
      } catch (e) {
        console.error(`Error getting from localStorage key '${key2}':`, e);
        return;
      }
      if (!Array.isArray(cohorts)) {
        console.error(`Expected an array for key '${key1}', but got:`, cohorts);
        return;
      }
      cohorts.forEach(cohortId => {
        fbq('trackCustom', 'AudienceLiftEntry', { audience_signal: cohortId });
        console.log('Sent non core custom event to pixel with params: ' + anonId + ', ' + cohortId);
        fbq('trackCustom', 'AudienceLiftEntry_' + cohortId );
        console.log('Sent core custom event to pixel with params: ' + anonId + ', ' + cohortId);
        
        // Where CAPI is implemented also POST to our Node server 
        return fetch('https://audiencelift.onrender.com:3000/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                anon_cuid: anonId,
                audience_signal: cohortId
            })
        })
        .then(response => {
            if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
                 console.log(`Error occured in S2S: ${response.status}`);
            }
            return response.json();
         });
         console.log('Sent custom event to CAPI with the params: ' + anonId + ', ' + cohortId);
      });
  })();
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1296628448762435&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->
</head>
<body>
  <h1>AudienceLift Demo</h1>
</body>
</html>
