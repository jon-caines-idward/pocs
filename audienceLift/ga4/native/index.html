<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GA4 AudienceLift - gtag</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P38QHLDQGM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P38QHLDQGM');
</script>
<script>
(function () {
  const STORAGE_KEY = 'cohort_ids';
  const LAST_SENT_KEY = 'last_sent_cohort_ids';

  function normalise(value) {
    return (value || '')
      .split(',')
      .map(c => c.trim())
      .filter(Boolean)
      .join(',');
  }

  function pushIfChanged(rawValue) {
    const normalised = normalise(rawValue);
    if (!normalised) return;

    const lastSent = localStorage.getItem(LAST_SENT_KEY) || '';
    if (normalised === lastSent) return;

    // With gtag, user properties can be set but only sent with an event
    //gtag('set', 'user_properties', { 'anonymised_audiences': normalised }); 
    gtag('event', 'AudienceLiftUpdate', {'audience_signal': normalised });

    localStorage.setItem(LAST_SENT_KEY, normalised);
    console.log('CohortDataChanged →', normalised);
  }

  // Page-load check (persistence across page views)
  pushIfChanged(localStorage.getItem(STORAGE_KEY));

  // Same-tab updates (wrap setItem)
  const nativeSetItem = localStorage.setItem;
  localStorage.setItem = function (key, value) {
    if (key === STORAGE_KEY) {
      pushIfChanged(value);
    }
    return nativeSetItem.apply(this, arguments);
  };

  // Cross-tab updates
  window.addEventListener('storage', function (e) {
    if (e.key === STORAGE_KEY) {
      pushIfChanged(e.newValue);
    }
  });
})();
</script>
</head>
<body>
  <h1>Sending AudienceLift Signals to GA4 using gtag</h1>
  <input 
    id="audSig"
    type="text"
    value="12345"
    placeholder="Enter audience signal"
  />
  ​<a href="#" name="button1" onclick="
  var audSigEl = document.getElementById('audSig');
  var audSig = audSigEl ? audSigEl.value : '';

  // Event-scoped cohort parameter
  if(audSig) {
    gtag('event', 'AudienceLiftUpdate', { 'audience_signal': audSig });
    console.log('AudienceLiftEntry cohort sent, event scoped, via gtag: ', audSig);
  }
">Send Signals to GA4 via gtag</a>
</body>
</html>
