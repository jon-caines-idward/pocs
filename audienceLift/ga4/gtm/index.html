<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GA4 AudienceLift - GTM</title>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WBKWRT72');</script>
  <!-- End Google Tag Manager -->
<script>
(function() {
  window.dataLayer = window.dataLayer || [];

  const STORAGE_KEY = 'cohort_ids';
  const EVENT_NAME = 'AudienceLiftUpdate';
  const LAST_SENT_KEY = 'last_sent_cohort_ids'; // store last pushed value

  // --- HELPER: push to dataLayer ---
  function pushCohortsToDataLayer(cohortString) {
    const cohortList = cohortString
      .split(',')
      .map(c => c.trim())
      .filter(c => c);

    if (cohortList.length === 0) return;

    window.dataLayer.push({
      event: EVENT_NAME,
      audience_signal: cohortList
    });

    console.log(`${EVENT_NAME} pushed to dataLayer:`, cohortList);

    // persist last sent value
    localStorage.setItem(LAST_SENT_KEY, cohortString);
  }

  // --- INITIAL CHECK ON PAGE LOAD ---
  let storedCohorts = localStorage.getItem(STORAGE_KEY) || '';
  let lastSent = localStorage.getItem(LAST_SENT_KEY) || '';

  if (storedCohorts && storedCohorts !== lastSent) {
    pushCohortsToDataLayer(storedCohorts);
  }

  // --- DETECT CHANGES IN SAME TAB ---
  // Wrap localStorage.setItem to detect updates
  const originalSetItem = localStorage.setItem;
  localStorage.setItem = function(key, value) {
    if (key === STORAGE_KEY) {
      const oldValue = localStorage.getItem(STORAGE_KEY) || '';
      if (value !== oldValue) {
        pushCohortsToDataLayer(value);
      }
    }
    return originalSetItem.apply(this, arguments);
  };

  // --- DETECT CHANGES FROM OTHER TABS ---
  window.addEventListener('storage', function(e) {
    if (e.key === STORAGE_KEY && e.newValue !== lastSent) {
      lastSent = e.newValue || '';
      if (lastSent) pushCohortsToDataLayer(lastSent);
    }
  });
})();
</script>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WBKWRT72"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <h1>Sending AudienceLift Signals to GA4 using GTM</h1>
  <input 
    id="audSig"
    type="text"
    value="12345"
    placeholder="Enter audience signal"
  />
  <a href="#" name="button1" onclick="
  window.dataLayer = window.dataLayer || [];

  var audSigEl = document.getElementById('audSig');
  var audSig = audSigEl ? audSigEl.value : '';
  var pushObj = { event: 'AudienceLiftUpdate', audience_signal: audSig };

  window.dataLayer.push(pushObj);

  console.log('AudienceLiftEntry sent via GTM with cohorts:', audSig);
">Send Signal to GA4 via GTM</a>
</body>
</html>
